# diary_analytic/loggers.py

import logging
import os
from datetime import datetime

# -------------------------------------------------------------------
# ðŸ“ ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
# -------------------------------------------------------------------

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð°Ð±ÑÐ¾Ð»ÑŽÑ‚Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ð´Ð¾ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ /logs, Ð½Ð°Ñ…Ð¾Ð´ÑÑ‰ÐµÐ¹ÑÑ Ð² ÐºÐ¾Ñ€Ð½Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
# (Ð½Ð° Ð¾Ð´Ð¸Ð½ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð²Ñ‹ÑˆÐµ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ñ„Ð°Ð¹Ð»Ð°, Ñ‚.Ðµ. Ð²Ñ‹ÑˆÐµ diary_analytic/)
LOG_DIR = os.path.join(os.path.dirname(os.path.dirname(__file__)), "logs")

# Ð•ÑÐ»Ð¸ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³ logs ÐµÑ‰Ñ‘ Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½ â€” ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ ÐµÐ³Ð¾ (Ð¸Ð½Ð°Ñ‡Ðµ FileNotFoundError)
os.makedirs(LOG_DIR, exist_ok=True)

# -------------------------------------------------------------------
# ðŸ§° Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð»Ð¾Ð³Ð³ÐµÑ€Ð°
# -------------------------------------------------------------------

def setup_logger(name: str, logfile: str) -> logging.Logger:
    """
    Ð£Ð½Ð¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð± ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð»Ð¾Ð³Ð³ÐµÑ€Ð° Ð´Ð»Ñ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð¿Ð¾Ð´ÑÐ¸ÑÑ‚ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.

    :param name: Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÐµÐµ Ð¸Ð¼Ñ Ð»Ð¾Ð³Ð³ÐµÑ€Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 'web', 'predict')
    :param logfile: Ð¸Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð°, Ð² ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð±ÑƒÐ´ÑƒÑ‚ Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ð»Ð¾Ð³Ð¸
    :return: Ð¾Ð±ÑŠÐµÐºÑ‚ Logger, Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹ Ð½Ð° Ð²Ñ‹Ð²Ð¾Ð´ Ð² Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð»Ð¾Ð³-Ñ„Ð°Ð¹Ð»

    ðŸ“Œ ÐŸÑ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð°:
    - Ð›Ð¾Ð³Ð³ÐµÑ€Ñ‹ ÑÐ¾Ð·Ð´Ð°ÑŽÑ‚ÑÑ Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ð¾
    - ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð»Ð¾Ð³Ð¸Ñ€ÑƒÐµÑ‚ ÑÐ²Ð¾ÑŽ Ð¿Ð¾Ð´ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ
    - Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð»Ð¾Ð³Ð¾Ð² Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ñ‹Ð¹ Ð¸ ÑÑ‚Ð°Ð±Ð¸Ð»ÐµÐ½
    """

    # ÐÐ±ÑÐ¾Ð»ÑŽÑ‚Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ð´Ð¾ Ñ„Ð°Ð¹Ð»Ð° Ð»Ð¾Ð³Ð¾Ð² (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: /logs/web.log)
    path = os.path.join(LOG_DIR, logfile)

    # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð»Ð¾Ð³ Ð¿Ñ€Ð¸ ÐºÐ°Ð¶Ð´Ð¾Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ ÐºÐ¾Ð¿Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ€Ð¾Ðµ (mode="w" Ð½Ð° ÑÑ‚Ð°Ñ€Ñ‚Ðµ)
    open(path, 'w').close()

    # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ Ð»Ð¾Ð³Ð³ÐµÑ€Ð°
    logger = logging.getLogger(name)
    logger.setLevel(logging.DEBUG)  # ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°ÐµÐ¼ Ð²ÑÑ‘, Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÑƒ

    # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð»Ð¾Ð³Ð¾Ð², Ð·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽÑ‰Ð¸Ð¹ Ð² Ñ„Ð°Ð¹Ð»
    handler = logging.FileHandler(path, mode="a", encoding="utf-8")

    # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð»Ð¾Ð³Ð°
    formatter = logging.Formatter("[%(asctime)s] [%(name)s] [%(funcName)s] â€” %(message)s")
    handler.setFormatter(formatter)

    # ÐŸÑ€Ð¸Ð²ÑÐ·Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ðº Ð»Ð¾Ð³Ð³ÐµÑ€Ñƒ
    logger.addHandler(handler)

    # ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð±ÑƒÑ„ÐµÑ€Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ Ð»Ð¾Ð³Ð³ÐµÑ€Ð°
    logger.propagate = False

    # ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑÐ±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ð±ÑƒÑ„ÐµÑ€ Ð¿Ð¾ÑÐ»Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ð·Ð°Ð¿Ð¸ÑÐ¸
    handler.flush = lambda: handler.stream.flush()

    # Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¹ Ð»Ð¾Ð³Ð³ÐµÑ€
    return logger

# -------------------------------------------------------------------
# ðŸ”§ Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹Ðµ Ð»Ð¾Ð³Ð³ÐµÑ€Ñ‹ Ð¿Ð¾Ð´ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ð¿Ð¾Ð´ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
# -------------------------------------------------------------------

# ðŸ“˜ WEB: Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹, Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ñ‹, Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†, GET/POST Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
web_logger = setup_logger("web", "web.log")
web_logger.info("ðŸš€ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½ web-Ð»Ð¾Ð³Ð³ÐµÑ€")

# ðŸ“Š ML: Ð²Ñ‹Ð·Ð¾Ð² Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹, ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð·Ð¾Ð², Ð¾Ð±ÑŠÑÑÐ½ÐµÐ½Ð¸Ñ, Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹
predict_logger = setup_logger("predict", "predict.log")
predict_logger.info("ðŸš€ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½ predict-Ð»Ð¾Ð³Ð³ÐµÑ€")

# ðŸ—ƒï¸ Ð‘Ð”: ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Entry, EntryValue, Parameter
db_logger = setup_logger("db", "db.log")
db_logger.info("ðŸš€ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½ db-Ð»Ð¾Ð³Ð³ÐµÑ€")

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð»Ð¾Ð³Ð³ÐµÑ€ Ð´Ð»Ñ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
error_logger = logging.getLogger("error")
error_logger.setLevel(logging.ERROR)
error_handler = logging.FileHandler(os.path.join(LOG_DIR, "error.log"), encoding="utf-8")
error_handler.setFormatter(logging.Formatter("[%(asctime)s] [%(name)s] [%(funcName)s] â€” %(message)s"))
error_logger.addHandler(error_handler)

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð² error.log
def log_error(logger_name, error_msg, exc_info=None):
    error_logger.error(f"[{logger_name}] {error_msg}", exc_info=exc_info)

# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð´Ð»Ñ Ð²ÑÐµÑ… Ð»Ð¾Ð³Ð³ÐµÑ€Ð¾Ð²
for logger in [web_logger, predict_logger, db_logger]:
    class ErrorHandler(logging.Handler):
        def emit(self, record):
            if record.levelno >= logging.ERROR:
                log_error(record.name, record.getMessage(), record.exc_info)
    
    logger.addHandler(ErrorHandler())

# Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ
web_logger.info("ðŸš€ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½ web-Ð»Ð¾Ð³Ð³ÐµÑ€")
predict_logger.info("ðŸš€ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½ predict-Ð»Ð¾Ð³Ð³ÐµÑ€")
db_logger.info("ðŸš€ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½ db-Ð»Ð¾Ð³Ð³ÐµÑ€")
error_logger.info("ðŸš€ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½ error-Ð»Ð¾Ð³Ð³ÐµÑ€")

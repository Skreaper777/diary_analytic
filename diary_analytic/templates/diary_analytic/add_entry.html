{% load static %}
{% load diary_filters %}
{% load diary_tags %}
{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–§–æ—Ä–º–∞ –¥–Ω–µ–≤–Ω–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{% static 'css/add_entry.css' %}">
</head>
<body>
  <script id="values-map" type="application/json">
    {{ values_map|json_script:"values-map" }}
  </script>
  <script>
    const VALUES_MAP = JSON.parse(document.getElementById('values-map').textContent);
    window.VALUES_MAP = VALUES_MAP;
  </script>
  <div class="container">
    <h2>üìò –î–Ω–µ–≤–Ω–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚Äî {{ selected_date }}</h2>
    <div class="date-selector" style="margin-bottom: 28px; margin-top: 0; display: flex; justify-content: flex-end;">
      <input
        id="date-input"
        type="date"
        value="{{ selected_date|date:'Y-m-d' }}"
        onchange="window.location.href='?date='+encodeURIComponent(this.value)"
      />
    </div>
    <button id="retrain-models-btn" type="button" style="width:100%;margin-bottom:35px;padding:12px;font-size:1.1em;background:#007bff;color:white;border:none;border-radius:10px;cursor:pointer;">üîÅ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑—ã</button>

    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã -->
    <div class="sort-buttons-row">
      <div class="sort-btns-left">
        <button type="button" class="sort-btn" data-sort="name">–ò–º—è <span class="sort-arrow"></span></button>
        <button type="button" class="sort-btn" data-sort="value">–ó–Ω–∞—á–µ–Ω–∏–µ <span class="sort-arrow"></span></button>
        <button type="button" class="sort-btn" data-sort="sum">–°—É–º–º–∞ <span class="sort-arrow"></span></button>
        <button type="button" class="sort-btn" data-sort="prediction">–ü—Ä–æ–≥–Ω–æ–∑ <span class="sort-arrow"></span></button>
      </div>

    </div>

    <div id="charts-date-range-block" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; max-width: 340px;">
      <button type="button" class="charts-toggle-btn" id="predictions-toggle-btn">–ü—Ä–æ–≥–Ω–æ–∑</button>
      <button type="button" class="charts-toggle-btn" id="charts-toggle-btn" style="margin-left:0;">–ì—Ä–∞—Ñ–∏–∫–∏</button>
      <label for="charts-min-date" style="color:#bbb;font-size:0.98em; margin-left: 8px;">–°&nbsp;–¥–∞—Ç—ã:</label>
      <input type="date" id="charts-min-date" style="min-width: 220px; background:#222;color:#eee;border:1.5px solid #444;border-radius:8px;padding:7px 12px;font-size:1em;outline:none;" />
    </div>

    <div class="filter-row" style="margin-top: 35px; margin-bottom: 35px; display: flex; justify-content: flex-start; align-items: center; gap: 8px;">
      <input id="param-filter-input" type="text" placeholder="–§–∏–ª—å—Ç—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤..." autocomplete="off" />
      <button type="button" class="filter-clear-btn" aria-label="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; border: none; background: #eee; color: #888; font-size: 1.2em; cursor: pointer; margin-left: 4px;">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="8" cy="8" r="8" fill="#eee"/>
          <path d="M5.5 5.5L10.5 10.5M10.5 5.5L5.5 10.5" stroke="#888" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    {% for param in parameters %}
      <div class="parameter-block" data-key="{{ param.key }}" data-param="{{ param.key }}">
        <div class="param-title">{{ param.name }}</div>
        <div class="param-flex-row" style="display: flex; align-items: flex-start; gap: 18px;">
          <div class="rating-buttons">
            {% for i in "012345"|make_list %}
              <button class="value-button{% if values_map|get:param.key|stringformat:'g' == i %} selected{% endif %}" data-value="{{ i }}">{{ i }}</button>
            {% endfor %}
          </div>
          <div class="param-sum-block" id="param-sum-{{ param.key }}" style="min-width: 25px; height: 2.5rem; display: flex; align-items: center; justify-content: center; background:rgba(0, 123, 255, 0.29); color: #eee; border: 2px solid #007bff; border-radius: 6px; font-size: 1em; margin-left: 10px; padding: 0 10px; font-weight: bold;"></div>
          <div class="param-sum-block-range" id="param-sum-range-{{ param.key }}" style="min-width: 25px; height: 2.5rem; display: flex; align-items: center; justify-content: center; background:rgba(40, 167, 70, 0.66); color: #eee; border: 2px solid #28a745; border-radius: 6px; font-size: 1em; margin-left: 0px; padding: 0 10px; font-weight: bold;">‚Äì</div>
          <div class="prediction-wrapper" style="margin-top: 0;">
            <div class="prediction-block">
              <div class="prediction-title">–ü—Ä–æ–≥–Ω–æ–∑</div>
              <div class="predicted" id="predicted-{{ param.key }}">‚Äì</div>
              <div class="predicted-secondary" id="predicted-delta-{{ param.key }}">Œî ‚Äì</div>
            </div>
          </div>
        </div>
        <div class="history-chart-block" style="display:none;">
          <canvas id="history-chart-{{ param.key }}" height="90"></canvas>
          <div class="history-chart-empty" id="history-chart-empty-{{ param.key }}" style="display:none;color:#888;text-align:center;font-size:0.95em;margin-top:4px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</div>
        </div>
      </div>
    {% endfor %}

    <!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –±–ª–æ–∫ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –ø–æ –≤—Å–µ–º –º–æ–¥–µ–ª—è–º 
    {% if predictions_by_model %}
      {% for model_name, model_predictions in predictions_by_model.items %}
        <div class="prediction-block model-{{ model_name }}">
          <h3>–ü—Ä–æ–≥–Ω–æ–∑—ã –ø–æ –º–æ–¥–µ–ª–∏ <strong>{{ model_name }}</strong></h3>
          <ul>
            {% for param, value in model_predictions.items %}
              <li><strong>{{ param }}</strong>: {{ value|floatformat:2 }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endfor %}
    {% endif %}-->

    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–≤ —Å–∞–º–æ–º –Ω–∏–∑—É) -->
    <form method="post" style="margin-top: 40px;">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
    </form>
  </div>

  <script src="{% static 'js/diary.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</body>
</html>

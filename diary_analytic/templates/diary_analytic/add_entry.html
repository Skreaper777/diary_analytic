{% load static %}
{% load diary_filters %}
{% load diary_tags %}
{% load param_title_split %}

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–§–æ—Ä–º–∞ –¥–Ω–µ–≤–Ω–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{% static 'css/add_entry.css' %}?v=1.0.6">
</head>
<body>
  <script id="values-map" type="application/json">
    {{ values_map|json_script:"values-map" }}
  </script>
  <script>
    const VALUES_MAP = JSON.parse(document.getElementById('values-map').textContent);
    window.VALUES_MAP = VALUES_MAP;
  </script>
  <div class="container">
    <h2>üìò –î–Ω–µ–≤–Ω–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚Äî {{ selected_date }}</h2>
    <div class="date-selector" style="margin-bottom: 28px; margin-top: 0; display: flex; justify-content: flex-end;">
      <input
        id="date-input"
        type="date"
        lang="ru-RU"
        value="{{ selected_date|date:'Y-m-d' }}"
        onchange="window.location.href='?date='+encodeURIComponent(this.value)"
      />
    </div>
    <button id="retrain-models-btn" type="button" style="width:100%;margin-bottom:35px;padding:12px;font-size:1.1em;background:#007bff;color:white;border:none;border-radius:10px;cursor:pointer;">üîÅ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑—ã</button>

    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã -->
    <div class="sort-buttons-row">
      <div class="sort-btns-left">
        <button type="button" class="sort-btn" data-sort="name">–ò–º—è <span class="sort-arrow"></span></button>
        <button type="button" class="sort-btn" data-sort="value">–ó–Ω–∞—á–µ–Ω–∏–µ <span class="sort-arrow"></span></button>
        <button type="button" class="sort-btn" data-sort="sum">–°—É–º–º–∞ <span class="sort-arrow"></span></button>
        <button type="button" class="sort-btn" data-sort="prediction">–ü—Ä–æ–≥–Ω–æ–∑ <span class="sort-arrow"></span></button>
        <button type="button" class="sort-btn" id="def-btn" style="background:#28a745;color:white;">def</button>
      </div>

    </div>

    <div id="charts-date-range-block" class="charts-date-range-block">
      <button type="button" class="charts-toggle-btn" id="focus-toggle-btn">–§–æ–∫—É—Å</button>
      <button type="button" class="charts-toggle-btn" id="comments-toggle-btn">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
      <button type="button" class="charts-toggle-btn" id="predictions-toggle-btn">–ü—Ä–æ–≥–Ω–æ–∑</button>
      <button type="button" class="charts-toggle-btn" id="charts-toggle-btn" style="margin-left:0;">–ì—Ä–∞—Ñ–∏–∫–∏</button>
      <label for="charts-min-date" style="color:#bbb;font-size:0.98em; margin-left: 8px;">–°&nbsp;–¥–∞—Ç—ã:</label>
      <input type="date" id="charts-min-date" lang="ru-RU" style="min-width: 220px; background:#222;color:#eee;border:1.5px solid #444;border-radius:8px;padding:7px 12px;font-size:1em;outline:none;" />
    </div>

    <div class="filter-row" style="margin-top: 35px; margin-bottom: 35px; display: flex; justify-content: flex-start; align-items: center; gap: 8px;">
      <input id="param-filter-input" type="text" placeholder="–§–∏–ª—å—Ç—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤..." autocomplete="off" />
      <button type="button" class="filter-clear-btn" aria-label="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" title="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä" style="display: flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; border: none; background: #eee; color: #888; font-size: 1.2em; cursor: pointer; margin-left: 4px;">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="8" cy="8" r="8" fill="#eee"/>
          <path d="M5.5 5.5L10.5 10.5M10.5 5.5L5.5 10.5" stroke="#888" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    {% for param in parameters %}
      <div class="parameter-block" data-key="{{ param.key }}" data-param="{{ param.key }}">
        <div class="param-title">
          {% for level, part in param.name|split_param_title %}
            <div class="param-title-level-{{ level }}">{{ part }}</div>
          {% endfor %}
        </div>
        <div class="param-flex-row" style="display: flex; align-items: flex-start;">
          <div class="rating-buttons">
            {% for i in "012345"|make_list %}
              <button class="value-button{% if values_map|get:param.key|stringformat:'g' == i %} selected{% endif %}" data-value="{{ i }}">{{ i }}</button>
            {% endfor %}
          </div>
          <div class="param-sum-block-range" id="param-sum-range-{{ param.key }}" style="">‚Äì</div>
          <div class="param-sum-block" id="param-sum-{{ param.key }}"></div>
          <div class="prediction-wrapper" style="margin-top: 0;">
            <div class="prediction-block">
              <div class="prediction-title">–ü—Ä–æ–≥–Ω–æ–∑</div>
              <div class="predicted" id="predicted-{{ param.key }}">‚Äì</div>
              <div class="predicted-secondary" id="predicted-delta-{{ param.key }}">Œî ‚Äì</div>
            </div>
          </div>
        </div>
        <div class="history-chart-block" style="display:none;">
          <canvas id="history-chart-{{ param.key }}" height="90"></canvas>
          <div class="history-chart-empty" id="history-chart-empty-{{ param.key }}" style="display:none;color:#888;text-align:center;font-size:0.95em;margin-top:4px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</div>
        </div>
        <!-- –ë–ª–æ–∫ –æ–ø–∏—Å–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ -->
        <div class="param-description-block" data-param-key="{{ param.key }}" style="margin-top:12px;display:none;">
          <label for="param-description-{{ param.key }}" style="font-size:0.98em;color:#888;">–û–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:</label>
          <textarea id="param-description-{{ param.key }}" class="param-description-textarea" rows="3" style="width:100%;resize:vertical;min-height:60px;max-height:200px;">{{ param.description|default_if_none:'' }}</textarea>
          <button class="save-description-btn" data-param-key="{{ param.key }}" style="display:none;margin-top:6px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <div class="save-description-status" style="font-size:0.95em;color:#28a745;margin-top:4px;display:none;">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</div>
        </div>
      </div>
    {% endfor %}

    <!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –±–ª–æ–∫ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –ø–æ –≤—Å–µ–º –º–æ–¥–µ–ª—è–º 
    {% if predictions_by_model %}
      {% for model_name, model_predictions in predictions_by_model.items %}
        <div class="prediction-block model-{{ model_name }}">
          <h3>–ü—Ä–æ–≥–Ω–æ–∑—ã –ø–æ –º–æ–¥–µ–ª–∏ <strong>{{ model_name }}</strong></h3>
          <ul>
            {% for param, value in model_predictions.items %}
              <li><strong>{{ param }}</strong>: {{ value|floatformat:2 }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endfor %}
    {% endif %}-->

    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–≤ —Å–∞–º–æ–º –Ω–∏–∑—É) -->
    <form method="post" style="margin-top: 40px;">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
    </form>
  </div>

  <script src="{% static 'js/diary.js' %}?v=1.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script>
    // JS –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏–π
    document.addEventListener('DOMContentLoaded', function() {
      // –ö–Ω–æ–ø–∫–∞ "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏"
      const commentsBtn = document.getElementById('comments-toggle-btn');
      commentsBtn.addEventListener('click', function() {
        document.querySelectorAll('.param-description-block').forEach(block => {
          block.style.display = (block.style.display === 'none' || block.style.display === '') ? 'block' : 'none';
        });
      });
      // –î–ª—è –∫–∞–∂–¥–æ–≥–æ textarea –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
      document.querySelectorAll('.param-description-textarea').forEach(textarea => {
        const paramKey = textarea.closest('.param-description-block').dataset.paramKey;
        const saveBtn = textarea.parentElement.querySelector('.save-description-btn');
        const statusDiv = textarea.parentElement.querySelector('.save-description-status');
        let lastValue = textarea.value;
        textarea.addEventListener('input', function() {
          if (textarea.value !== lastValue) {
            saveBtn.style.display = 'inline-block';
            statusDiv.style.display = 'none';
          } else {
            saveBtn.style.display = 'none';
          }
        });
        saveBtn.addEventListener('click', function() {
          fetch('/api/set_parameter_description/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key: paramKey, description: textarea.value })
          })
          .then(resp => resp.json())
          .then(data => {
            if (data.success) {
              lastValue = textarea.value;
              saveBtn.style.display = 'none';
              statusDiv.style.display = 'block';
              setTimeout(() => { statusDiv.style.display = 'none'; }, 1500);
            }
          });
        });
      });
    });
  </script>
</body>
</html>
